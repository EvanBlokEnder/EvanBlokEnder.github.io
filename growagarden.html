<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow A Garden Live Stock Display</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#3b43ff" />
  <style>
    /* [Same CSS as before, no changes needed] */
    body { font-family: Arial, sans-serif; background: #f0f8ff; padding: 20px; }
    h1 { text-align: center; margin-bottom: 1rem; }
    #status { text-align: center; margin-bottom: 20px; font-weight: bold; color: #1e40af; }
    #refresh-btn, #subscribe-btn {
      display: block; margin: 0 auto 20px auto; padding: 10px 20px; font-size: 16px;
      color: white; border: none; border-radius: 5px; cursor: pointer;
    }
    #refresh-btn { background: #6a9955; }
    #refresh-btn:hover { background: #57803e; }
    #subscribe-btn { background: #3b82f6; }
    #subscribe-btn:hover { background: #2563eb; }
    .stock-category { margin-bottom: 30px; }
    .stock-category h2 {
      border-bottom: 2px solid #6a9955; padding-bottom: 5px; color: #2f4f2f; text-transform: capitalize;
    }
    .items { display: flex; flex-wrap: wrap; gap: 15px; }
    .item-card {
      background: white; border-radius: 8px; box-shadow: 0 0 8px #ccc;
      padding: 10px; width: 150px; text-align: center;
    }
    .item-card img {
      max-width: 100px; max-height: 100px; object-fit: contain; margin-bottom: 8px;
    }
    .item-name { font-weight: bold; margin-bottom: 4px; color: #333; }
    .item-qty { color: #666; }
    #status-checker {
      background: #d9e8ff; border: 2px solid #3b82f6; border-radius: 8px;
      padding: 15px; max-width: 400px; margin: 10px auto 30px auto;
      text-align: center; box-shadow: 0 0 10px #3b82f6aa;
    }
    #status-checker h2 { margin-top: 0; margin-bottom: 10px; color: #1e40af; }
    #status-text { font-weight: bold; font-size: 1.2em; margin-bottom: 8px; color: #1e3a8a; }
    #uptime { font-size: 0.9em; color: #2563eb; }
  </style>
</head>
<body>

<h1>🌱 Grow A Garden Live Feed</h1>

<div id="status-checker">
  <h2>Status Checker</h2>
  <div id="status-text">Polling...</div>
  <div id="uptime">Uptime: 0s</div>
</div>

<div id="status">Connecting to API...</div>
<button id="refresh-btn">🔄 Refresh</button>
<button id="subscribe-btn">🔔 Subscribe</button>
<div id="stock-container"></div>

<script>
const stockURL = 'https://corsproxy.io/?https://api.joshlei.com/v2/growagarden/stock';
const statusEl = document.getElementById('status');
const container = document.getElementById('stock-container');
const refreshBtn = document.getElementById('refresh-btn');
const subscribeBtn = document.getElementById('subscribe-btn');
const statusTextEl = document.getElementById('status-text');
const uptimeEl = document.getElementById('uptime');

let latestData = {};
let isFirstUpdate = true;
let notificationSent = false;
let uptimeSeconds = 0;

function updateStatus(text, color = '#1e40af') {
  statusEl.textContent = text;
  statusTextEl.textContent = text;
  statusTextEl.style.color = color;
}

function updateUptime() {
  uptimeSeconds++;
  uptimeEl.textContent = `Uptime: ${uptimeSeconds}s`;
}

setInterval(updateUptime, 1000);

function notifyUpdateOnce() {
  if (!("Notification" in window)) return;
  if (Notification.permission === "granted" && !notificationSent) {
    const notification = new Notification("Grow A Garden Stock Updated!", {
      body: "Click to refresh the page and see the latest stock.",
      icon: "https://api.joshlei.com/v2/growagarden/item/image/carrot"
    });
    notification.onclick = () => {
      window.focus();
      location.reload();
    };
    notificationSent = true;
  }
}

function hasDataChanged(oldData, newData) {
  return JSON.stringify(oldData) !== JSON.stringify(newData);
}

function displayStock(data) {
  if (!hasDataChanged(latestData, data)) return;
  latestData = data;
  notificationSent = false;
  container.innerHTML = '';

  for (const category in data) {
    if (!Array.isArray(data[category])) continue;

    const section = document.createElement('div');
    section.className = 'stock-category';

    const title = document.createElement('h2');
    title.textContent = category.replace(/_/g, ' ');
    section.appendChild(title);

    const itemsDiv = document.createElement('div');
    itemsDiv.className = 'items';

    data[category].forEach(item => {
      if (item.icon) {
        const card = document.createElement('div');
        card.className = 'item-card';

        const img = document.createElement('img');
        img.src = item.icon;
        img.alt = item.display_name || item.item_id;
        card.appendChild(img);

        const name = document.createElement('div');
        name.className = 'item-name';
        name.textContent = item.display_name || item.item_id;
        card.appendChild(name);

        const qty = document.createElement('div');
        qty.className = 'item-qty';
        qty.textContent = `Quantity: ${item.quantity || 0}`;
        card.appendChild(qty);

        itemsDiv.appendChild(card);
      }
    });

    section.appendChild(itemsDiv);
    container.appendChild(section);
  }

  if (!isFirstUpdate) notifyUpdateOnce();
  else isFirstUpdate = false;
}

async function fetchStock() {
  try {
    updateStatus("Fetching latest stock...", "#1e40af");
    const res = await fetch(stockURL);
    const json = await res.json();
    displayStock(json);
    updateStatus("Live stock updated ✅", "#16a34a");
  } catch (err) {
    console.error('Fetch error:', err);
    updateStatus("Failed to fetch stock ❌", "#dc2626");
  }
}

// Initial fetch + polling every 15 seconds
fetchStock();
setInterval(fetchStock, 15000);

// Button actions
refreshBtn.onclick = () => location.reload();

function updateSubscribeBtnText() {
  if (!("Notification" in window)) {
    subscribeBtn.textContent = "🔕 Notifications Not Supported";
    subscribeBtn.disabled = true;
    return;
  }
  const perm = Notification.permission;
  subscribeBtn.textContent =
    perm === "granted" ? "🔔 Subscribed" :
    perm === "denied" ? "🔕 Permission Denied" : "🔔 Subscribe";
  subscribeBtn.disabled = perm !== "default";
}

subscribeBtn.onclick = () => {
  if (!("Notification" in window)) return alert("Notifications not supported.");
  Notification.requestPermission().then(() => {
    updateSubscribeBtnText();
  });
};

updateSubscribeBtnText();

// Register service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('service-worker.js')
    .then(() => console.log('Service Worker registered'))
    .catch(err => console.error('SW registration failed:', err));
}
</script>

</body>
</html>
