<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow A Garden Live Feed</title>
  <meta name="theme-color" content="#4caf50" />
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Verdana, sans-serif;
      margin: 0;
      background: url('BACKGROUND_URL') no-repeat center center fixed;
      background-size: cover;
      color: #333;
    }

    .navbar {
      display: flex;
      background: rgba(62, 142, 65, 0.9);
      padding: 12px;
      justify-content: center;
      gap: 12px;
      font-weight: bold;
      box-shadow: 0 4px 8px rgba(0,0,0,0.4);
    }

    .tab {
      background: #66bb6a;
      padding: 10px 24px;
      border-radius: 8px;
      color: white;
      cursor: pointer;
      transition: background 0.3s;
    }

    .tab:hover {
      background: #4caf50;
    }

    h1 {
      text-align: center;
      margin: 20px;
      color: #2e7d32;
      font-size: 2.4em;
    }

    #status-checker {
      background: rgba(255,255,255,0.85);
      border: 3px solid #4caf50;
      border-radius: 10px;
      padding: 20px;
      max-width: 500px;
      margin: 10px auto 30px auto;
      text-align: center;
      box-shadow: 0 6px 12px rgba(0,0,0,0.3);
    }

    #status, #status-text {
      font-size: 1.1em;
      font-weight: bold;
      margin-bottom: 8px;
    }

    #refresh-btn, #subscribe-btn {
      display: block;
      margin: 10px auto;
      padding: 12px 24px;
      font-size: 15px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: bold;
      box-shadow: 0 3px 6px rgba(0,0,0,0.2);
    }

    #refresh-btn { background: #ffa000; color: white; }
    #refresh-btn:hover { background: #ff8f00; }
    #subscribe-btn { background: #00c853; color: white; }
    #subscribe-btn:hover { background: #00b341; }

    .stock-category {
      margin: 20px;
      padding: 12px;
      background: rgba(255,255,255,0.9);
      border: 3px solid #4caf50;
      border-radius: 10px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }

    .stock-category h2 {
      margin: 0 0 10px 0;
      color: #2e7d32;
      padding: 8px;
      border-radius: 6px;
      background: rgba(76,175,80,0.8);
      text-align: center;
      font-size: 1.3em;
    }

    .items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
      justify-content: center;
    }

    .item-card {
      background: #fff;
      border: 2px solid #f0ad4e;
      border-radius: 8px;
      padding: 8px;
      width: 140px;
      text-align: center;
      box-shadow: 0 3px 6px rgba(0,0,0,0.15);
    }

    .item-card img {
      width: 90px;
      height: 90px;
      object-fit: contain;
    }

    .item-name {
      font-weight: bold;
      margin-top: 6px;
      color: #333;
      font-size: 0.95em;
    }

    .item-qty {
      color: #555;
      font-size: 0.9em;
    }

    .rarity {
      font-size: 11px;
      font-weight: bold;
      padding: 3px;
      border-radius: 4px;
      margin-bottom: 4px;
      color: white;
    }

    .common { background: #9e9e9e; }
    .uncommon { background: #66bb6a; }
    .rare { background: #42a5f5; }
    .epic { background: #ab47bc; }
  </style>
</head>
<body>

<div class="navbar">
  <div class="tab">🌱 Live Stock</div>
  <div class="tab">🛒 Shop</div>
  <div class="tab">🔔 Notifications</div>
</div>

<h1>Grow A Garden Live Feed 🌻</h1>

<div id="status-checker">
  <div id="status-text">Checking server...</div>
  <div id="uptime">Uptime: 0s</div>
</div>

<div id="status">Connecting to API...</div>
<button id="refresh-btn">🔄 Refresh</button>
<button id="subscribe-btn">🔔 Subscribe</button>
<div id="stock-container"></div>

<script>
const stockURL = 'https://corsproxy.io/?https://api.joshlei.com/v2/growagarden/stock';
const statusEl = document.getElementById('status');
const container = document.getElementById('stock-container');
const refreshBtn = document.getElementById('refresh-btn');
const subscribeBtn = document.getElementById('subscribe-btn');
const statusTextEl = document.getElementById('status-text');
const uptimeEl = document.getElementById('uptime');

let latestData = {}, first = true, notified = false, seconds = 0;

function updateStatus(msg, col='#2e7d32'){ statusEl.textContent = msg; statusTextEl.textContent = msg; statusTextEl.style.color = col; }
setInterval(()=>{ seconds++; uptimeEl.textContent = `Uptime: ${seconds}s`; },1000);

function notify() {
  if (!("Notification" in window) || notified) return;
  if (Notification.permission === "granted") {
    new Notification("Garden Stock Updated!", { body: "Reload to see latest stock!", icon: container.querySelector('img')?.src });
    notified = true;
  }
}

function hasChanged(o,n){ return JSON.stringify(o)!==JSON.stringify(n); }
function rarity(q){
  if(q>=50)return 'common';
  if(q>=20)return 'uncommon';
  if(q>=5)return 'rare';
  return 'epic';
}

function display(data){
  if(!hasChanged(latestData,data)) return;
  latestData=data; notified=false; container.innerHTML='';
  for(const cat in data){
    const arr=data[cat];
    if(!Array.isArray(arr)) continue;
    const sec=document.createElement('div'); sec.className='stock-category';
    const h2=document.createElement('h2'); h2.textContent=cat.replace(/_/g,' '); sec.appendChild(h2);
    const items=document.createElement('div'); items.className='items';
    arr.forEach(it=>{
      if(it.icon){
        const card=document.createElement('div'); card.className='item-card';
        const r=rarity(it.quantity||0);
        const rb=document.createElement('div'); rb.className=`rarity ${r}`; rb.textContent=r.toUpperCase();
        card.appendChild(rb);
        const img=document.createElement('img'); img.src=it.icon; img.alt=it.display_name||it.item_id; card.appendChild(img);
        const nm=document.createElement('div'); nm.className='item-name'; nm.textContent=it.display_name||it.item_id; card.appendChild(nm);
        const qty=document.createElement('div'); qty.className='item-qty'; qty.textContent=`Qty: ${it.quantity||0}`; card.appendChild(qty);
        items.appendChild(card);
      }
    });
    sec.appendChild(items); container.appendChild(sec);
  }
  if(!first) notify(); else first=false;
}

async function fetchStock(){
  try{ updateStatus("Fetching stock...","#2e7d32");
    const j=await (await fetch(stockURL)).json();
    display(j); updateStatus("Stock updated ✅","#00c853");
  }catch(e){ console.error(e); updateStatus("Failed to fetch ❌","#c62828"); }
}
fetchStock(); setInterval(fetchStock,15000);
refreshBtn.onclick = ()=>location.reload();
subscribeBtn.onclick = ()=>Notification.requestPermission().then(()=>{ subscribeBtn.textContent = Notification.permission==="granted" ? "🔔 Subscribed" : Notification.permission==="denied"?"🔕 Denied":"🔔 Subscribe"; });
</script>

</body>
</html>
