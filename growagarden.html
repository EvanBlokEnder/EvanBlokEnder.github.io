<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Grow A Garden Live Stock Display</title>
  <link rel="manifest" href="manifest.json" />
  <meta name="theme-color" content="#3b43ff" />
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f0f8ff;
      padding: 20px;
    }
    h1 {
      text-align: center;
      margin-bottom: 1rem;
    }
    #status {
      text-align: center;
      margin-bottom: 20px;
      font-weight: bold;
      color: #1e40af;
    }
    #refresh-btn, #subscribe-btn {
      display: block;
      margin: 0 auto 20px auto;
      padding: 10px 20px;
      font-size: 16px;
      color: white;
      border: none;
      border-radius: 5px;
      cursor: pointer;
    }
    #refresh-btn {
      background: #6a9955;
    }
    #refresh-btn:hover {
      background: #57803e;
    }
    #subscribe-btn {
      background: #3b82f6;
    }
    #subscribe-btn:hover {
      background: #2563eb;
    }
    .stock-category {
      margin-bottom: 30px;
    }
    .stock-category h2 {
      border-bottom: 2px solid #6a9955;
      padding-bottom: 5px;
      color: #2f4f2f;
      text-transform: capitalize;
    }
    .items {
      display: flex;
      flex-wrap: wrap;
      gap: 15px;
    }
    .item-card {
      background: white;
      border-radius: 8px;
      box-shadow: 0 0 8px #ccc;
      padding: 10px;
      width: 150px;
      text-align: center;
    }
    .item-card img {
      max-width: 100px;
      max-height: 100px;
      object-fit: contain;
      margin-bottom: 8px;
    }
    .item-name {
      font-weight: bold;
      margin-bottom: 4px;
      color: #333;
    }
    .item-qty {
      color: #666;
    }

    /* Styles for Status Checker */
    #status-checker {
      background: #d9e8ff;
      border: 2px solid #3b82f6;
      border-radius: 8px;
      padding: 15px;
      max-width: 400px;
      margin: 10px auto 30px auto;
      text-align: center;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      box-shadow: 0 0 10px #3b82f6aa;
    }
    #status-checker h2 {
      margin-top: 0;
      margin-bottom: 10px;
      color: #1e40af;
    }
    #status-text {
      font-weight: bold;
      font-size: 1.2em;
      margin-bottom: 8px;
      color: #1e3a8a;
    }
    #uptime {
      font-size: 0.9em;
      color: #2563eb;
    }
  </style>
</head>
<body>

<h1>ðŸŒ± Grow A Garden Live Feed</h1>

<!-- Status Checker embed -->
<div id="status-checker">
  <h2>Status Checker</h2>
  <div id="status-text">Connecting...</div>
  <div id="uptime">Uptime: 0s</div>
</div>

<div id="status">Connecting to WebSocket...</div>
<button id="refresh-btn" title="Refresh Page">ðŸ”„ Refresh</button>
<button id="subscribe-btn" title="Subscribe for Notifications">ðŸ”” Subscribe</button>
<div id="stock-container"></div>

<script>
  const WS_URL = 'wss://websocket.joshlei.com/growagarden/';
  const statusEl = document.getElementById('status');
  const container = document.getElementById('stock-container');
  const refreshBtn = document.getElementById('refresh-btn');
  const subscribeBtn = document.getElementById('subscribe-btn');

  // Status Checker elements
  const statusTextEl = document.getElementById('status-text');
  const uptimeEl = document.getElementById('uptime');

  let socket = null;
  let reconnectDelay = 3000;
  let reconnecting = false;
  let latestData = {};
  let isFirstUpdate = true;
  let notificationSentForCurrentData = false;

  let openTimeout = null;  // Timeout timer to track 13 seconds until open

  refreshBtn.onclick = () => location.reload();

  // --- Main WebSocket for stock updates ---
  function hasDataChanged(oldData, newData) {
    try {
      return JSON.stringify(oldData) !== JSON.stringify(newData);
    } catch {
      return true;
    }
  }

  function notifyUpdateOnce() {
    if (!("Notification" in window)) return;

    if (Notification.permission === "granted" && !notificationSentForCurrentData) {
      showNotification();
      notificationSentForCurrentData = true;
    }
  }

  function showNotification() {
    const notification = new Notification("Grow A Garden Stock Updated!", {
      body: "Click to refresh the page and see the latest stock.",
      icon: "https://api.joshlei.com/v2/growagarden/item/image/carrot"
    });
    notification.onclick = () => {
      window.focus();
      location.reload();
    };
  }

  function displayStock(data) {
    if (!hasDataChanged(latestData, data)) return;

    latestData = data;
    notificationSentForCurrentData = false;

    container.innerHTML = '';

    for (const category in data) {
      if (!Array.isArray(data[category])) continue;

      const section = document.createElement('div');
      section.className = 'stock-category';

      const title = document.createElement('h2');
      title.textContent = category.replace(/_/g, ' ');
      section.appendChild(title);

      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'items';

      data[category].forEach(item => {
        if (item.icon && typeof item.icon === 'string') {
          const card = document.createElement('div');
          card.className = 'item-card';

          const img = document.createElement('img');
          img.src = item.icon;
          img.alt = item.display_name || item.item_id || "Item";
          card.appendChild(img);

          const name = document.createElement('div');
          name.className = 'item-name';
          name.textContent = item.display_name || item.item_id;
          card.appendChild(name);

          const qty = document.createElement('div');
          qty.className = 'item-qty';
          qty.textContent = `Quantity: ${item.quantity || 0}`;
          card.appendChild(qty);

          itemsDiv.appendChild(card);
        }
      });

      section.appendChild(itemsDiv);
      container.appendChild(section);
    }

    if (!isFirstUpdate) {
      notifyUpdateOnce();
    } else {
      isFirstUpdate = false;
    }
  }

  function connect() {
    socket = new WebSocket(WS_URL);

    // Set timeout for open event - 13 seconds
    openTimeout = setTimeout(() => {
      if (socket.readyState !== WebSocket.OPEN) {
        statusEl.textContent = "Connection timed out, reloading in 3 seconds...";
        socket.close(); // Close if still not open
        setTimeout(() => {
          location.reload();
        }, 3000);
      }
    }, 13000);

    socket.onopen = () => {
      clearTimeout(openTimeout); // Clear timeout on successful open
      statusEl.textContent = 'Connected to Grow A Garden Stock WebSocket';
      reconnecting = false;
      console.log('WebSocket connected');
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (typeof data === 'object') {
          displayStock(data);
        }
      } catch (e) {
        console.warn('Invalid JSON from websocket:', e, event.data);
      }
    };

    socket.onerror = (error) => {
      clearTimeout(openTimeout);
      console.error('WebSocket error:', error);
      socket.close();
    };

    socket.onclose = (event) => {
      clearTimeout(openTimeout);
      if (statusEl.textContent.startsWith("Connection timed out")) {
        // Already handled timeout reload
        return;
      }
      statusEl.textContent = `Disconnected (code ${event.code}), reconnecting in ${reconnectDelay / 1000}s...`;
      if (!reconnecting) {
        reconnecting = true;
        setTimeout(connect, reconnectDelay);
      }
    };
  }

  connect();

  // On page load, update subscribe button text according to current permission state
  function updateSubscribeBtnText() {
    if (!("Notification" in window)) {
      subscribeBtn.textContent = "ðŸ”• Notifications Not Supported";
      subscribeBtn.disabled = true;
      subscribeBtn.style.cursor = "not-allowed";
    } else {
      const perm = Notification.permission;
      if (perm === "granted") {
        subscribeBtn.textContent = "ðŸ”” Subscribed";
        subscribeBtn.disabled = true;
        subscribeBtn.style.cursor = "default";
      } else if (perm === "denied") {
        subscribeBtn.textContent = "ðŸ”• Permission Denied";
        subscribeBtn.disabled = true;
        subscribeBtn.style.cursor = "not-allowed";
      } else {
        subscribeBtn.textContent = "ðŸ”” Subscribe";
        subscribeBtn.disabled = false;
        subscribeBtn.style.cursor = "pointer";
      }
    }
  }

  subscribeBtn.onclick = () => {
    if (!("Notification" in window)) {
      alert("Notifications are not supported by your browser.");
      return;
    }

    if (Notification.permission === "default") {
      Notification.requestPermission().then(permission => {
        updateSubscribeBtnText();
        if (permission === "granted") {
          alert("Thank you for subscribing to notifications!");
        } else if (permission === "denied") {
          alert("You denied notification permission. You can enable it in your browser settings.");
        }
      });
    } else {
      alert(`Notification permission is already "${Notification.permission}".`);
    }
  };

  updateSubscribeBtnText();

  // PWA: Register Service Worker
  if ('serviceWorker' in navigator) {
    navigator.serviceWorker.register('service-worker.js')
      .then(() => console.log('Service Worker registered'))
      .catch(err => console.error('SW registration failed:', err));
  }

  // --- Status Checker WebSocket ---
  let statusSocket = null;
  let statusReconnectDelay = 3000;
  let statusConnected = false;
  let uptimeSeconds = 0;
  let uptimeInterval = null;

  function updateStatusText(text, color = '#1e3a8a') {
    statusTextEl.textContent = text;
    statusTextEl.style.color = color;
  }

  function updateUptimeText() {
    uptimeEl.textContent = `Uptime: ${uptimeSeconds}s`;
  }

  function resetUptime() {
    uptimeSeconds = 0;
    updateUptimeText();
    if (uptimeInterval) {
      clearInterval(uptimeInterval);
      uptimeInterval = null;
    }
  }

  function startUptimeCounter() {
    if (uptimeInterval) clearInterval(uptimeInterval);
    uptimeInterval = setInterval(() => {
      uptimeSeconds++;
      updateUptimeText();
    }, 1000);
  }

  function connectStatusSocket() {
    updateStatusText('Connecting...', '#1e3a8a');
    resetUptime();

    statusSocket = new WebSocket(WS_URL);

    statusSocket.onopen = () => {
      statusConnected = true;
      updateStatusText('Connected', '#16a34a'); // green
      startUptimeCounter();
    };

    statusSocket.onmessage = (event) => {
      // No processing needed here for status checker
    };

    statusSocket.onerror = (error) => {
      console.error('Status WebSocket error:', error);
      updateStatusText('Error', '#dc2626'); // red
      statusSocket.close();
    };

    statusSocket.onclose = (event) => {
      statusConnected = false;
      updateStatusText(`Disconnected (code ${event.code}), reconnecting...`, '#b45309'); // amber
      resetUptime();
      setTimeout(connectStatusSocket, statusReconnectDelay);
    };
  }

  connectStatusSocket();

</script>

</body>
</html>
