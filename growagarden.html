<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Grow A Garden Live Stock Display</title>
<style>
  body {
    font-family: Arial, sans-serif;
    background: #f0f8ff;
    padding: 20px;
  }
  h1 {
    text-align: center;
    margin-bottom: 1rem;
  }
  #status {
    text-align: center;
    margin-bottom: 10px;
    font-weight: bold;
  }
  #refresh-btn {
    display: block;
    margin: 0 auto 20px auto;
    padding: 8px 16px;
    font-size: 16px;
    background-color: #6a9955;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
  }
  #refresh-btn:hover {
    background-color: #558b2f;
  }
  .stock-category {
    margin-bottom: 30px;
  }
  .stock-category h2 {
    border-bottom: 2px solid #6a9955;
    padding-bottom: 5px;
    color: #2f4f2f;
    text-transform: capitalize;
  }
  .items {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
  }
  .item-card {
    background: white;
    border-radius: 8px;
    box-shadow: 0 0 8px #ccc;
    padding: 10px;
    width: 150px;
    text-align: center;
  }
  .item-card img {
    max-width: 100px;
    max-height: 100px;
    object-fit: contain;
    margin-bottom: 8px;
  }
  .item-name {
    font-weight: bold;
    margin-bottom: 4px;
    color: #333;
  }
  .item-qty {
    color: #666;
  }
</style>
</head>
<body>

<h1>ðŸŒ± Grow A Garden Live Feed</h1>
<div id="status">Connecting to WebSocket...</div>
<button id="refresh-btn" title="Refresh Page">ðŸ”„ Refresh</button>
<div id="stock-container"></div>

<script>
(() => {
  const WS_URL = 'wss://websocket.joshlei.com/growagarden/';
  const statusEl = document.getElementById('status');
  const container = document.getElementById('stock-container');
  const refreshBtn = document.getElementById('refresh-btn');

  let socket = null;
  let reconnectDelay = 3000;
  let reconnecting = false;

  // Store latest data by category and item id for diffing and updating in place
  let latestData = {};

  // Request notification permission on page load
  function requestNotificationPermission() {
    if ('Notification' in window && Notification.permission === 'default') {
      Notification.requestPermission().then(permission => {
        console.log('Notification permission:', permission);
      });
    }
  }

  // Show notification if permission granted
  function showNotification(title, options) {
    if ('Notification' in window && Notification.permission === 'granted') {
      const notification = new Notification(title, options);
      notification.onclick = () => {
        window.focus();
        location.reload();
      };
    }
  }

  // Update or create stock category section
  function updateCategory(category, items) {
    // Try to find existing section or create it
    let section = container.querySelector(`div.stock-category[data-category="${category}"]`);
    if (!section) {
      section = document.createElement('div');
      section.className = 'stock-category';
      section.dataset.category = category;

      const title = document.createElement('h2');
      title.textContent = category.replace(/_/g, ' ');
      section.appendChild(title);

      const itemsDiv = document.createElement('div');
      itemsDiv.className = 'items';
      section.appendChild(itemsDiv);

      container.appendChild(section);
    }

    const itemsDiv = section.querySelector('.items');

    // Create map of current item cards by item_id for easy update
    const existingCards = {};
    itemsDiv.querySelectorAll('.item-card').forEach(card => {
      existingCards[card.dataset.itemId] = card;
    });

    // Add/update item cards
    items.forEach(item => {
      if (!item.icon || typeof item.icon !== 'string') return;

      let card = existingCards[item.item_id];
      if (!card) {
        // Create new card
        card = document.createElement('div');
        card.className = 'item-card';
        card.dataset.itemId = item.item_id;

        const img = document.createElement('img');
        img.alt = item.display_name || item.item_id || "Item";
        card.appendChild(img);

        const name = document.createElement('div');
        name.className = 'item-name';
        card.appendChild(name);

        const qty = document.createElement('div');
        qty.className = 'item-qty';
        card.appendChild(qty);

        itemsDiv.appendChild(card);
      }

      // Update card contents
      const img = card.querySelector('img');
      img.src = item.icon;

      const name = card.querySelector('.item-name');
      name.textContent = item.display_name || item.item_id;

      const qty = card.querySelector('.item-qty');
      qty.textContent = `Quantity: ${item.quantity || 0}`;

      // Remove this card from existingCards map so we know which to remove later
      delete existingCards[item.item_id];
    });

    // Remove cards that no longer exist in the new data
    for (const removedId in existingCards) {
      existingCards[removedId].remove();
    }
  }

  // Remove categories not in new data
  function removeOldCategories(newCategories) {
    [...container.querySelectorAll('.stock-category')].forEach(section => {
      if (!newCategories.includes(section.dataset.category)) {
        section.remove();
      }
    });
  }

  // Check if two data objects differ meaningfully
  function hasDataChanged(oldData, newData) {
    return JSON.stringify(oldData) !== JSON.stringify(newData);
  }

  // Display stock updates efficiently without wiping the entire container
  function displayStock(data) {
    if (!hasDataChanged(latestData, data)) {
      return; // no changes
    }
    latestData = data;

    const newCategories = Object.keys(data).filter(cat => Array.isArray(data[cat]));

    // Remove old categories no longer present
    removeOldCategories(newCategories);

    // Update or add each category
    newCategories.forEach(category => {
      updateCategory(category, data[category]);
    });

    // Show notification about update
    showNotification('Grow A Garden Update', {
      body: 'Stock data updated.',
      icon: 'https://api.joshlei.com/v2/growagarden/item/image/carrot',
      tag: 'growagarden-stock-update', // avoids stacking notifications
      renotify: true,
    });
  }

  // WebSocket connect + reconnect logic
  function connect() {
    socket = new WebSocket(WS_URL);

    socket.onopen = () => {
      statusEl.textContent = 'Connected to Grow A Garden Stock WebSocket';
      reconnecting = false;
      console.log('WebSocket connected');
    };

    socket.onmessage = (event) => {
      try {
        const data = JSON.parse(event.data);
        if (typeof data === 'object') {
          displayStock(data);
        }
      } catch (e) {
        console.warn('Invalid JSON from websocket:', e, event.data);
      }
    };

    socket.onerror = (error) => {
      console.error('WebSocket error:', error);
      socket.close();
    };

    socket.onclose = (event) => {
      statusEl.textContent = `Disconnected (code ${event.code}), reconnecting in ${reconnectDelay / 1000}s...`;
      console.warn(`WebSocket closed: code ${event.code}, reason: ${event.reason || 'N/A'}`);
      if (!reconnecting) {
        reconnecting = true;
        setTimeout(connect, reconnectDelay);
      }
    };
  }

  refreshBtn.addEventListener('click', () => location.reload());

  // Start
  requestNotificationPermission();
  connect();
})();
</script>

</body>
</html>
